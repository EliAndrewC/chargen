<!doctype html>
<html>
    <head>
        <title>Character Generator</title>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.6.1/lodash.js"></script>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
        <script src="//cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
        <script>
            var types = {{ types|tojson }},
                config = {{ config|tojson }};

            String.prototype.title = function () {
                return this.substring(0, 1).toUpperCase() + this.substring(1);
            };

            var dropdownPopulator = function (src, dest) {
                var $src = dom['$' + src],
                    $dest = dom['$' + dest];
                $src.on('change', function () {
                    $dest.empty();
                    $dest.append('<option value="">' + dest.title() + '</option>');
                    _.each(_.get(config[src], $src.val()), function (ignored, val) {
                        $dest.append(
                            $('<option></option>').attr('value', val).text(val.title()));
                    });
                });
            };

            var dom = {};
            var currentCharacter = null;
            var currentImageData = null;  // Store generated image base64 data
            var cropper = null;  // Cropper.js instance for headshot selection

            $(function () {
                $.each(['base_rank', 'type', 'generate', 'upload', 'fields', 'clan', 'family', 'house', 'lineage', 'art_section', 'art_prompt', 'generate_art', 'art_result', 'art_image', 'art_loading', 'headshot_preview', 'cropper_container'], function (i, s) {
                    dom['$' + s] = $('#' + s);
                });
                dom.$upload.prop('disabled', true);
                dom.$generate.prop('disabled', true);
                dom.$generate_art.prop('disabled', true);

                $.each(types, function (i, type) {
                    dom.$type.append(
                        $('<option></option>')
                            .text(type)
                            .attr('value', type));
                });

                dom.$type.on('change', function () {
                    dom.$generate.prop('disabled', dom.$type.val() !== 'Peasant');
                    var ranks = config.ranks[dom.$type.val()];
                    dom.$base_rank.empty();
                    if (_(ranks).size() > 1) {
                        dom.$base_rank.append('<option value="">Rank</option>');
                    }
                    _(ranks).toPairs().sortBy(function (pair) {
                        return parseInt(pair[0]);
                    }).each(function (pair) {
                        dom.$base_rank.append(
                            $('<option></option>')
                                .text(pair[1])
                                .attr('value', pair[0]));
                    });
                });
                dom.$base_rank.on('change', function () {
                    dom.$generate.prop('disabled', dom.$type.val() !== 'Peasant' && !dom.$base_rank.val());
                });
                dom.$type.val(config.default_character_type).change();

                dropdownPopulator('clan', 'family');
                dropdownPopulator('family', 'house');
                dropdownPopulator('house', 'lineage');

                dom.$generate.on('click', function () {
                    var params = {};
                    _(['base_rank', 'type', 'clan', 'family', 'house', 'lineage']).each(function (field) {
                        params[field] = dom['$' + field].val();
                    });
                    $.getJSON('generate', _.pickBy(params), function (character) {
                        if (character.error) {
                            alert(character.error);
                        } else {
                            currentCharacter = character;
                            currentImageData = null;  // Reset image when generating new character
                            // Destroy cropper if active
                            if (cropper) {
                                cropper.destroy();
                                cropper = null;
                            }
                            dom.$fields.empty();
                            dom.$upload.prop('disabled', false);

                            var fields = [
                                $('<input type="text" id="name" />').val(character.full_name),
                                $('<input type="text" id="summary" />'),
                                $('<input type="text" id="tags" />').val(character.tags.join(', ')),
                                $('<textarea rows="12" id="public" />').text(character.public),
                                $('<textarea rows="12" id="private" />').text(character.private)
                            ];
                            $.each(fields, function(i, $field) {
                                dom.$fields.append(
                                    $field.css("width", "100%")
                                ).append("<br/>");
                            });
                            $('#summary').focus();

                            // Reset art section and fetch suggested prompt
                            dom.$art_section.show();
                            dom.$art_result.hide();
                            dom.$art_prompt.val('Loading prompt...');
                            dom.$generate_art.prop('disabled', true);

                            $.getJSON('art_prompt', {
                                gender: character.gender,
                                clan: character.clan || '',
                                school: character.school || '',
                                xp: character.xp || 150,
                                traits: (character.traits || []).join(', ')
                            }, function(resp) {
                                dom.$art_prompt.val(resp.prompt);
                                dom.$generate_art.prop('disabled', false);
                            });
                        }
                    });
                });

                dom.$generate_art.on('click', function () {
                    var prompt = dom.$art_prompt.val();
                    dom.$generate_art.prop('disabled', true);
                    dom.$art_loading.show();
                    dom.$art_result.hide();

                    // Destroy existing cropper if any
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }

                    $.getJSON('generate_art', {prompt: prompt}, function(resp) {
                        dom.$art_loading.hide();
                        dom.$generate_art.prop('disabled', false);

                        if (resp.error) {
                            alert('Art generation failed: ' + resp.error);
                        } else {
                            currentImageData = resp.image;  // Store the base64 image data
                            dom.$art_image.attr('src', 'data:image/png;base64,' + resp.image);
                            dom.$art_result.show();

                            // Initialize cropper for headshot selection after image loads
                            dom.$art_image.one('load', function() {
                                var img = dom.$art_image[0];
                                var crop = resp.headshot_crop;

                                // Calculate the scale between natural and displayed size
                                var displayWidth = img.width;
                                var displayHeight = img.height;
                                var naturalWidth = img.naturalWidth;
                                var naturalHeight = img.naturalHeight;

                                cropper = new Cropper(img, {
                                    viewMode: 1,
                                    dragMode: 'move',
                                    autoCropArea: 1,
                                    restore: false,
                                    guides: true,
                                    center: true,
                                    highlight: true,
                                    cropBoxMovable: true,
                                    cropBoxResizable: true,
                                    toggleDragModeOnDblclick: false,
                                    ready: function() {
                                        // Set initial crop box to the detected headshot region
                                        if (crop) {
                                            this.cropper.setData({
                                                x: crop.x,
                                                y: crop.y,
                                                width: crop.width,
                                                height: crop.height
                                            });
                                        }
                                        updateHeadshotPreview();
                                    },
                                    crop: function() {
                                        updateHeadshotPreview();
                                    }
                                });
                            });
                        }
                    });
                });

                function updateHeadshotPreview() {
                    if (!cropper) return;
                    try {
                        var canvas = cropper.getCroppedCanvas({
                            width: 150,
                            height: 150,
                            imageSmoothingEnabled: true,
                            imageSmoothingQuality: 'high'
                        });
                        if (canvas) {
                            dom.$headshot_preview.attr('src', canvas.toDataURL());
                        }
                    } catch (e) {
                        // Ignore errors during cropper initialization
                    }
                }

                dom.$upload.on('click', function() {
                    var params = {};
                    $.each(['name', 'summary', 'tags', 'public', 'private'], function(i, param) {
                        params[param] = $('#' + param).val();
                    });
                    // Include image data if an image was generated
                    if (currentImageData) {
                        params.image_data = currentImageData;
                        // Include headshot crop coordinates if cropper is active
                        if (cropper) {
                            var cropData = cropper.getData(true);  // true = rounded integers
                            params.headshot_crop = {
                                x: cropData.x,
                                y: cropData.y,
                                width: cropData.width,
                                height: cropData.height
                            };
                        }
                    }
                    // Use POST instead of GET to handle large image data
                    $.ajax({
                        url: 'upload',
                        type: 'POST',
                        data: JSON.stringify(params),
                        contentType: 'application/json',
                        dataType: 'json',
                        success: function(resp) {
                            if (resp.error) {
                                alert(resp.error);
                            } else {
                                // Destroy cropper before hiding
                                if (cropper) {
                                    cropper.destroy();
                                    cropper = null;
                                }
                                dom.$upload.attr('disabled', true);
                                dom.$art_section.hide();
                                dom.$fields.empty().append(
                                    $('<b/>').text(params.name + ' has been uploaded')
                                ).append("<br/>").append(
                                    $('<a target="_blank" />').attr('href', resp.view_url).text('View')
                                ).append('&nbsp;&nbsp;&nbsp;&nbsp;').append(
                                    $('<a target="_blank" />').attr('href', resp.edit_url).text('Edit')
                                );
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('Upload failed: ' + error);
                        }
                    });
                });
            });
        </script>
    </head>
    <body>
        <select id="type"></select>
        <select id="base_rank">
            <option value="">Rank</option>
        </select>
        <select id="clan">
            <option value="">Clan</option>
            {% for clan in config.clans %}
                <option value="{{ clan }}">{{ clan|title }}</option>
            {% endfor %}
        </select>
        <select id="family">
            <option value="">Family</option>
        </select>
        <select id="house">
            <option value="">House</option>
        </select>
        <select id="lineage">
            <option value="">Lineage</option>
        </select>
        <button id="generate">Generate</button>
        <button id="upload">Upload</button>
        <div id="fields" style="margin-right:40%"></div>

        <div id="art_section" style="margin-top: 20px; display: none;">
            <h3>Character Art</h3>
            <p>Edit the prompt below if desired, then click Generate Art:</p>
            <textarea id="art_prompt" rows="8" style="width: 100%; max-width: 600px;"></textarea>
            <br/>
            <button id="generate_art">Generate Art</button>
            <span id="art_loading" style="display: none; margin-left: 10px;">Generating image, please wait...</span>
            <div id="art_result" style="margin-top: 15px; display: none;">
                <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
                    <div>
                        <p style="margin: 0 0 5px 0;"><strong>Full Image</strong> (for bio) - drag the box to select headshot:</p>
                        <div id="cropper_container" style="max-width: 512px; max-height: 512px;">
                            <img id="art_image" style="max-width: 100%; display: block;" />
                        </div>
                    </div>
                    <div>
                        <p style="margin: 0 0 5px 0;"><strong>Avatar Preview</strong> (headshot):</p>
                        <img id="headshot_preview" style="width: 150px; height: 150px; border: 1px solid #ccc; object-fit: cover; background: #f0f0f0;" />
                    </div>
                </div>
                <br/>
                <small>Adjust the crop box to select the headshot region for the avatar. If you don't like the image, edit the prompt above and click Generate Art again.</small>
            </div>
        </div>
    </body>
</html>
